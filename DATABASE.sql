USE master
GO
--TAO DATABASE---------------------------------------------------------------------
IF DB_ID ('QLKS') IS NOT NULL
	DROP DATABASE QLKS
GO
CREATE DATABASE QLKS
GO
USE QLKS
GO
--TAO BANG-----------------------------------------------------------------------------
/*
DROP TABLE TAIKHOAN
DROP TABLE HOADON
DROP TABLE CHITIETPHIEUDV
DROP TABLE PHIEUDICHVU
DROP TABLE PHIEUNHANPHONG
DROP TABLE PHIEUDATPHONG
DROP TABLE PHIEU
DROP TABLE DICHVUTOUR
DROP TABLE DICHVU
DROP TABLE KHACHHANG
DROP TABLE DOITAC
DROP TABLE NHANVIEN
DROP TABLE PHONG
*/
CREATE TABLE NHANVIEN
(
	MANV INT,
	TEN NVARCHAR(100),
	EMAIL VARCHAR(100),
	SDT VARCHAR(20),
	VAITRO NVARCHAR(20),
	DIACHI NVARCHAR(20),
	LUONG FLOAT,

	CONSTRAINT PK_NV PRIMARY KEY (MANV)
)

CREATE TABLE PHONG 
(
	MAPHONG VARCHAR(5),
	GIA FLOAT,
	TINHTRANG NVARCHAR(10),
	VESINH NVARCHAR(10),
	QUYDINH NVARCHAR(100),
	LOAIPHONG NVARCHAR(20),

	CONSTRAINT PK_P	PRIMARY KEY (MAPHONG)
)

CREATE TABLE KHACHHANG
(
	MAKH INT,
	TEN NVARCHAR(100),
	EMAIL VARCHAR(100),
	SDT VARCHAR(20),
	DIACHI NVARCHAR(100),
	CMND VARCHAR(20),
	DOANKHACH NVARCHAR(100)

	CONSTRAINT PK_KH PRIMARY KEY (MAKH)
)

CREATE TABLE DOITAC
(
	MADT INT,
	TENDT NVARCHAR(100),
	EMAIL VARCHAR(100),
	SDT VARCHAR(20),
	DIACHITRUSOCHINH NVARCHAR(100),
	SLDV INT,

	CONSTRAINT PK_DT PRIMARY KEY (MADT)
)

CREATE TABLE DICHVU
(
	MADV VARCHAR(5),
	TENDV NVARCHAR(100),
	GIA FLOAT,
	LICHHOATDONG NVARCHAR(20),
	LOAIHINH NVARCHAR(100),

	CONSTRAINT PK_DV PRIMARY KEY (MADV)
)

CREATE TABLE DICHVUTOUR
(
	MADV VARCHAR(5),
	MADT INT,
	SOLUONGTOIDA INT,
	DIADIEM NVARCHAR(100),

	CONSTRAINT PK_DVT PRIMARY KEY (MADV, MADT),

	CONSTRAINT FK_DVT_DV FOREIGN KEY(MADV) REFERENCES DICHVU ON DELETE CASCADE,
	CONSTRAINT FK_DVT_DT FOREIGN KEY(MADT) REFERENCES DOITAC ON DELETE CASCADE
)

CREATE TABLE PHIEU
(
	MAPHIEU INT,
	KHACHHANG INT,
	NVLAPPHIEU INT

	CONSTRAINT PK_PHIEU PRIMARY KEY (MAPHIEU),

	CONSTRAINT FK_PHIEU_KH FOREIGN KEY(KHACHHANG) REFERENCES KHACHHANG ON DELETE CASCADE,
	CONSTRAINT FK_PHIEU_NV FOREIGN KEY(NVLAPPHIEU) REFERENCES NHANVIEN ON DELETE CASCADE
)
CREATE TABLE PHIEUDATPHONG
(
	MAPHIEU INT,
	PHONG VARCHAR(5),
	TINHTRANG NVARCHAR(100),
	NGAYDEN DATETIME,
	SODEMLUUTRU INT,
	YEUCAUKHACHHANG NVARCHAR(100),
	LOAIPHONG NVARCHAR(20),

	CONSTRAINT PK_HD PRIMARY KEY (MAPHIEU),
	
	CONSTRAINT FK_PDP_P FOREIGN KEY(PHONG) REFERENCES PHONG ON DELETE CASCADE,
	CONSTRAINT FK_PDP_PHIEU FOREIGN KEY(MAPHIEU) REFERENCES PHIEU ON DELETE NO ACTION
)
CREATE TABLE PHIEUNHANPHONG
(
	MAPHIEU INT,
	PHONG VARCHAR(5),
	TINHTRANG NVARCHAR(100),
	NVDANKHACH INT,
	THOIGIAN DATETIME,
	VANCHUYENHANHLY BIT

	CONSTRAINT PK_PNP PRIMARY KEY (MAPHIEU),

	CONSTRAINT FK_PNP_PHIEU FOREIGN KEY(MAPHIEU) REFERENCES PHIEU ON DELETE NO ACTION,
	CONSTRAINT FK_PNP_P FOREIGN KEY(PHONG) REFERENCES PHONG ON DELETE CASCADE,
	CONSTRAINT FK_PNP_NHANVIEN FOREIGN KEY(NVDANKHACH) REFERENCES NHANVIEN ON DELETE NO ACTION,
)
CREATE TABLE PHIEUDICHVU
(
	MAPHIEU INT,
	KHACHHANG INT,
	NGAY DATETIME,
	TONGTIEN FLOAT,
	SLDV INT, CHECK(SLDV > 0),

	CONSTRAINT PK_PDV PRIMARY KEY (MAPHIEU),

	CONSTRAINT FK_PDV_KH FOREIGN KEY(KHACHHANG) REFERENCES KHACHHANG ON DELETE CASCADE,
)
CREATE TABLE CHITIETPHIEUDV
(
	MAPHIEU INT,
	MADV VARCHAR(5),
	LICHDANGKY NVARCHAR(20),
	GIA FLOAT,
	SONGUOITHAMGIA INT,
	VANCHUYEN BIT,
	TINHTRANG NVARCHAR(20)

	CONSTRAINT PK_CTPDV PRIMARY KEY (MAPHIEU, MADV),

	CONSTRAINT FK_CTPDV_PDV FOREIGN KEY(MAPHIEU) REFERENCES PHIEUDICHVU ON DELETE CASCADE,
	CONSTRAINT FK_CTPDV_DV FOREIGN KEY(MADV) REFERENCES DICHVU ON DELETE CASCADE,
	

)
CREATE TABLE HOADON
(
	MAHD INT,
	MAKH INT,
	TONGTIEN FLOAT,
	SOTIENTHANHTOANTRUOC FLOAT,
	HTTT NVARCHAR(50),
	TINHTRANG NVARCHAR(50),
	THOIGIAN DATETIME,
	PHIEU INT,
	DICHVU INT

	CONSTRAINT PK_HDON PRIMARY KEY (MAHD),
	CONSTRAINT FK_HDON_PHIEU FOREIGN KEY(PHIEU) REFERENCES PHIEU,
	CONSTRAINT FK_HDON_PDV FOREIGN KEY(DICHVU) REFERENCES PHIEUDICHVU
)

CREATE TABLE TAIKHOAN 
(
	USERNAME VARCHAR(100), CHECK(USERNAME IS NOT NULL),
	PASSWORD VARCHAR(100), CHECK(PASSWORD IS NOT NULL),
	USERID INT

	CONSTRAINT PK_TK PRIMARY KEY (USERNAME, PASSWORD)
)
-- THEM DU LIEU----------------------------------------------------------------------------------------
INSERT INTO NHANVIEN VALUES
(1, N'Nguyễn Văn A', 'NVA@gmail.com', 0987654321, 'Letan', null, 6000),
(2, N'Nguyễn Văn B', 'NVB@gmail.com', 0987654322, 'Bellman', null, 6000),
(3, N'Nguyễn Văn C', 'NVC@gmail.com', 0987654323, 'Vesinh', null, 6000)

INSERT INTO PHONG VALUES
('P101', 200, N'TRỐNG', N'SẠCH', NULL,  N'ĐẢM BẢO'),
('P102', 150, N'TRỐNG', N'BẨN', NULL,  N'KHÔNG ĐẢM BẢO'),
('P103', 300, N'ĐẦY', N'SẠCH', NULL,  N'ĐẢM BẢO'),
('P201', 200, N'TRỐNG', N'SẠCH', NULL,  N'ĐẢM BẢO'),
('P202', 150, N'TRỐNG', N'BẨN', NULL,  N'KHÔNG ĐẢM BẢO'),
('P203', 300, N'TRỐNG', N'SẠCH', NULL,  N'ĐẢM BẢO')

INSERT INTO KHACHHANG VALUES
(11, N'Nguyễn Văn D', 'NVD@gmail.com', 0987654324,  null,  53236000, N'KHÔNG'),
(12, N'Nguyễn Văn E', 'NVE@gmail.com', 0987654325,  null,  53236001, N'ĐỒNG NAI'),
(13, N'Nguyễn Văn F', 'NVF@gmail.com', 0987654326,  null,  53236002, N'KHÔNG')

INSERT INTO DOITAC VALUES
(111, N'Nguyễn Văn G', 'NVG@gmail.com', 0987654327,  null,  1)

INSERT INTO DICHVU VALUES
('DV1', 'KARAOKE', 20, 'T2-T5-CN', N'THUONG'),
('DV2', 'RESTAURANT', 20, 'ALL', N'THUONG'),
('DV3', 'BI-A', 20, 'T3-T6-CN', N'THUONG'),
('DV4', 'SPA', 20, 'T4-T7-CN', N'THUONG'),
('DV5', 'GYM', 20, 'ALL', N'THUONG'),
('DV6', 'CAP TREO', 20, 'T2-T5-CN', N'TOUR')

INSERT INTO DICHVUTOUR VALUES
('DV6', 111, 50, N'NUI')

INSERT INTO PHIEU VALUES
(1234, 11, 1),
(1235, 12, 1),
(1236, 13, 1)

INSERT INTO PHIEUDATPHONG VALUES
(1234, 'P101', N'HOÀN THÀNH', '2023-4-30', 2, N'CÓ MÁY LẠNH', N'ĐẢM BẢO'),
(1235, 'P202', N'HOÀN THÀNH', '2023-4-30', 2, NULL, N'KHÔNG ĐẢM BẢO'),
(1236, 'P203', N'HOÀN THÀNH', '2023-4-30', 2, N'CÓ MÁY LẠNH', N'ĐẢM BẢO')

INSERT INTO PHIEUNHANPHONG VALUES
(1234, 'P101', N'CHƯA NHẬN', NULL, NULL, 0),
(1235, 'P101', N'ĐÃ NHẬN', 2, '2023-4-30  9:00:00', 1)

INSERT INTO PHIEUDICHVU VALUES
(12345, 11, '2023-4-30', 60, 3),
(12346, 12, '2023-4-30', 20, 1),
(12347, 13, '2023-4-30', 40, 2)

INSERT INTO CHITIETPHIEUDV VALUES
(12345, 'DV1', 'CN', 20, NULL, NULL, 'XN'),
(12345, 'DV2', 'CN', 20, NULL, NULL, 'XN'),
(12345, 'DV3', 'CN', 20, NULL, NULL, 'CXN'),
(12346, 'DV4', 'CN', 20, NULL, NULL, 'XN'),
(12346, 'DV5', 'CN', 20, NULL, NULL, 'CXN'),
(12346, 'DV6', 'CN', 20, 1, 1, 'XN')

INSERT INTO HOADON VALUES
(00111,11, 200, 20, NULL, 'CTT', '2023-4-30', 1234, NULL),
(00112,12, 150, 15, NULL, 'CTT', '2023-4-30', 1235, NULL),
(00113,13, 300, 30, NULL, 'CTT', '2023-4-30', 1236, NULL),
(00114,11, 200, 0, NULL, 'CTT', '2023-4-30', NULL, 12345),
(00115,12, 200, 0, NULL, 'CTT', '2023-4-30', NULL, 12346),
(00116,13, 200, 0, NULL, 'CTT', '2023-4-30', NULL, 12347)


INSERT INTO TAIKHOAN VALUES
('NVLT','PASS', 1),
('NVBM','PASS', 2),
('NVDVS','PASS', 3),
('DT','PASS', 111),
('KH1','PASS', 11),
('KH2','PASS', 2),
('KH3','PASS', 3)